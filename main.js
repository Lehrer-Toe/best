// Hauptsystem - NUR JSON-basiert, KEIN Firebase
console.log('üöÄ Main.js geladen - JSON-basiert, KEIN Firebase');

// Globale Variablen f√ºr Datenspeicherung
let currentUser = null;
let users = [];
let alleFaecherGlobal = {};
let bewertungsCheckpoints = {};
let themen = [];
let gruppen = [];
let bewertungen = [];
let vorlagen = {};
let news = [];
let schuljahr = '2025/26';
let briefvorlage = {};
let staerkenFormulierungen = {};
let aktuelleGruppeEdit = null;

// Daten laden beim Start
async function loadInitialData() {
    console.log('üìÇ loadInitialData() gestartet...');
    
    try {
        console.log('üìÇ Lade JSON-Dateien...');
        
        // Benutzer laden
        console.log('üìÇ Lade users.json...');
        const usersResponse = await fetch('users.json');
        if (!usersResponse.ok) throw new Error(`users.json HTTP ${usersResponse.status}`);
        const usersData = await usersResponse.json();
        users = usersData.users;
        console.log('‚úÖ Benutzer geladen:', users.length, 'Accounts');

        // F√§cher laden
        console.log('üìÇ Lade faecher.json...');
        const faecherResponse = await fetch('faecher.json');
        if (!faecherResponse.ok) throw new Error(`faecher.json HTTP ${faecherResponse.status}`);
        const faecherData = await faecherResponse.json();
        alleFaecherGlobal = faecherData.faecher;
        console.log('‚úÖ F√§cher geladen:', Object.keys(alleFaecherGlobal).length, 'F√§cher');

        // Bewertungscheckpoints laden
        console.log('üìÇ Lade bewertungsCheckpoints.json...');
        const checkpointsResponse = await fetch('bewertungsCheckpoints.json');
        if (!checkpointsResponse.ok) throw new Error(`bewertungsCheckpoints.json HTTP ${checkpointsResponse.status}`);
        const checkpointsData = await checkpointsResponse.json();
        bewertungsCheckpoints = checkpointsData.bewertungsCheckpoints;
        console.log('‚úÖ Bewertungscheckpoints geladen:', Object.keys(bewertungsCheckpoints).length, 'Kategorien');

        // Themen laden
        console.log('üìÇ Lade themen.json...');
        const themenResponse = await fetch('themen.json');
        if (!themenResponse.ok) throw new Error(`themen.json HTTP ${themenResponse.status}`);
        const themenData = await themenResponse.json();
        themen = themenData.themen;
        console.log('‚úÖ Themen geladen:', themen.length, 'Themen');

        // Briefvorlage laden
        console.log('üìÇ Lade briefvorlage.json...');
        const briefvorlageResponse = await fetch('briefvorlage.json');
        if (!briefvorlageResponse.ok) throw new Error(`briefvorlage.json HTTP ${briefvorlageResponse.status}`);
        const briefvorlageData = await briefvorlageResponse.json();
        briefvorlage = briefvorlageData.briefvorlage;
        console.log('‚úÖ Briefvorlage geladen');

        // System-Konfiguration laden
        console.log('üìÇ Lade config.json...');
        const configResponse = await fetch('config.json');
        if (!configResponse.ok) throw new Error(`config.json HTTP ${configResponse.status}`);
        const configData = await configResponse.json();
        schuljahr = configData.systemConfig.schuljahr;
        staerkenFormulierungen = configData.staerkenFormulierungen;
        console.log('‚úÖ System-Konfiguration geladen f√ºr Schuljahr:', schuljahr);

        console.log('‚úÖ ALLE Grunddaten erfolgreich geladen');
        
        // Demo-Daten laden
        await loadDemoData();
        
        console.log('üéâ System vollst√§ndig initialisiert - JSON-basiert');
        
    } catch (error) {
        console.error('‚ùå FEHLER beim Laden der Grunddaten:', error);
        throw error;
    }
}

// Demo-Daten laden (optional)
async function loadDemoData() {
    console.log('üìã Lade Demo-Daten...');
    
    try {
        // Demo-Gruppen laden
        const gruppenResponse = await fetch('demo-gruppen.json');
        if (gruppenResponse.ok) {
            const gruppenData = await gruppenResponse.json();
            gruppen = gruppenData.gruppen;
            console.log('‚úÖ Demo-Gruppen geladen:', gruppen.length);
        }

        // Demo-Bewertungen laden
        const bewertungenResponse = await fetch('demo-bewertungen.json');
        if (bewertungenResponse.ok) {
            const bewertungenData = await bewertungenResponse.json();
            bewertungen = bewertungenData.bewertungen;
            console.log('‚úÖ Demo-Bewertungen geladen:', bewertungen.length);
        }

        // Demo-Vorlagen laden
        const vorlagenResponse = await fetch('demo-vorlagen.json');
        if (vorlagenResponse.ok) {
            const vorlagenData = await vorlagenResponse.json();
            vorlagen = vorlagenData.vorlagen;
            console.log('‚úÖ Demo-Vorlagen geladen');
        }

        // Demo-News laden
        const newsResponse = await fetch('demo-news.json');
        if (newsResponse.ok) {
            const newsData = await newsResponse.json();
            news = newsData.news;
            console.log('‚úÖ Demo-News geladen:', news.length);
        }

        console.log('‚úÖ Demo-Daten erfolgreich geladen');
        
    } catch (error) {
        console.warn('‚ö†Ô∏è Demo-Daten konnten nicht geladen werden:', error);
        // Fallback zu leeren Arrays/Objekten
        gruppen = [];
        bewertungen = [];
        vorlagen = {};
        news = [];
        
        // Erstelle Basis-News
        addNews('System gestartet', 'Das Bewertungssystem wurde erfolgreich gestartet.', false, 'System');
    }
}

// App-Initialisierung nach Login
function initializeApp() {
    console.log('üöÄ Initialisiere App nach Login...');
    
    if (!currentUser) {
        console.error('‚ùå Kein Benutzer angemeldet!');
        return;
    }
    
    console.log('üë§ Benutzer:', currentUser.name, 'Rolle:', currentUser.role);
    
    // Lade Inhalte der aktiven Tabs
    try {
        loadNews();
        loadThemen();
        loadSchuelerLehrerAuswahl();
        console.log('‚úÖ App-Interface geladen');
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der App-Inhalte:', error);
    }
}

// Tab-Navigation
function openTab(tabName) {
    const contents = document.querySelectorAll('.tab-content');
    const buttons = document.querySelectorAll('.tab-btn');
    
    contents.forEach(content => content.classList.remove('active'));
    buttons.forEach(button => button.classList.remove('active'));
    
    document.getElementById(tabName).classList.add('active');
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    console.log('üìë Tab gewechselt zu:', tabName);
    
    // Tab-spezifische Inhalte laden
    try {
        if (tabName === 'news') loadNews();
        if (tabName === 'themen') loadThemen();
        if (tabName === 'gruppen') loadGruppen();
        if (tabName === 'lehrer') loadLehrer();
        if (tabName === 'daten') loadDatenverwaltung();
        if (tabName === 'bewerten') loadBewertungen();
        if (tabName === 'vorlagen') loadVorlagen();
        if (tabName === 'uebersicht') loadUebersicht();
        if (tabName === 'adminvorlagen') loadAdminVorlagen();
    } catch (error) {
        console.error('‚ùå Fehler beim Laden von Tab:', tabName, error);
    }
}

// Gruppen-System
function loadGruppen() {
    console.log('üë• Lade Gruppen...');
    
    const liste = document.getElementById('gruppenListe');
    if (!liste) return;
    
    let html = '';
    gruppen.forEach((gruppe, index) => {
        html += `<div class="liste-item">
            <div>
                <strong>${gruppe.thema}</strong><br>
                <small>Erstellt: ${gruppe.erstellt}</small><br>
                <div style="margin-top: 0.5rem;">`;
        
        gruppe.schueler.forEach(schueler => {
            const fachInfo = schueler.fach ? ` (${getFachNameFromGlobal(schueler.fach)})` : '';
            html += `${schueler.name} ‚Üí ${schueler.lehrer}${fachInfo}<br>`;
        });
        
        html += `</div>
            </div>
            <div>
                <button class="btn" onclick="gruppeBearbeiten(${index})">Bearbeiten</button>
                <button class="btn btn-danger" onclick="gruppeLoeschen(${index})">L√∂schen</button>
            </div>
        </div>`;
    });
    liste.innerHTML = html || '<div class="card"><p>Keine Gruppen vorhanden.</p></div>';
    
    console.log('üë• Gruppen geladen:', gruppen.length);
}

function getFachNameFromGlobal(fachKuerzel) {
    return alleFaecherGlobal[fachKuerzel] || fachKuerzel;
}

function loadSchuelerLehrerAuswahl() {
    console.log('üë®‚Äçüè´ Aktualisiere Lehrer-Auswahl...');
    
    const selects = document.querySelectorAll('.schueler-lehrer');
    const lehrerOptions = users.filter(u => u.role === 'lehrer')
        .map(lehrer => `<option value="${lehrer.name}">${lehrer.name}</option>`)
        .join('');
    
    selects.forEach(select => {
        select.innerHTML = '<option value="">Lehrer w√§hlen...</option>' + lehrerOptions;
    });
    
    // Fach-Selects auch laden
    const fachSelects = document.querySelectorAll('.schueler-fach');
    const fachOptions = Object.entries(alleFaecherGlobal)
        .map(([kuerzel, name]) => `<option value="${kuerzel}">${name}</option>`)
        .join('');
    
    fachSelects.forEach(select => {
        select.innerHTML = '<option value="">Fach w√§hlen...</option>' + fachOptions;
    });
    
    console.log('üë®‚Äçüè´ Lehrer-Auswahl aktualisiert');
}

function schuelerHinzufuegen() {
    const container = document.getElementById('schuelerListe');
    const newRow = document.createElement('div');
    newRow.className = 'input-group schueler-row';
    
    const lehrerOptions = users.filter(u => u.role === 'lehrer')
        .map(lehrer => `<option value="${lehrer.name}">${lehrer.name}</option>`)
        .join('');
    
    const fachOptions = Object.entries(alleFaecherGlobal)
        .map(([kuerzel, name]) => `<option value="${kuerzel}">${name}</option>`)
        .join('');
    
    newRow.innerHTML = `
        <input type="text" placeholder="Sch√ºlername" class="schueler-name">
        <select class="schueler-lehrer">
            <option value="">Lehrer w√§hlen...</option>
            ${lehrerOptions}
        </select>
        <select class="schueler-fach">
            <option value="">Fach w√§hlen...</option>
            ${fachOptions}
        </select>
        <button type="button" class="btn btn-danger" onclick="schuelerEntfernen(this)">Entfernen</button>
    `;
    
    container.appendChild(newRow);
    console.log('‚ûï Sch√ºler-Zeile hinzugef√ºgt');
}

function schuelerEntfernen(button) {
    const rows = document.querySelectorAll('.schueler-row');
    if (rows.length > 1) {
        button.parentElement.remove();
        console.log('‚ûñ Sch√ºler-Zeile entfernt');
    } else {
        alert('Mindestens ein Sch√ºler muss vorhanden sein!');
    }
}

function gruppeErstellen() {
    console.log('üë• Erstelle neue Gruppe...');
    
    const thema = document.getElementById('gruppenThema').value.trim();
    if (!thema) {
        alert('Bitte geben Sie ein Thema ein!');
        return;
    }

    const schuelerRows = document.querySelectorAll('.schueler-row');
    const schueler = [];
    
    for (let row of schuelerRows) {
        const name = row.querySelector('.schueler-name').value.trim();
        const lehrer = row.querySelector('.schueler-lehrer').value;
        const fach = row.querySelector('.schueler-fach').value;
        
        if (name && lehrer) {
            schueler.push({ name, lehrer, fach: fach || null });
        } else if (name) {
            alert(`Bitte w√§hlen Sie einen Lehrer f√ºr ${name}!`);
            return;
        }
    }

    if (schueler.length === 0) {
        alert('Bitte f√ºgen Sie mindestens einen Sch√ºler hinzu!');
        return;
    }

    const gruppe = { 
        thema, 
        schueler, 
        id: Date.now(),
        erstellt: new Date().toLocaleDateString('de-DE')
    };
    gruppen.push(gruppe);
    
    // News f√ºr jeden betroffenen Lehrer erstellen
    const lehrer = [...new Set(schueler.map(s => s.lehrer))];
    lehrer.forEach(lehrerName => {
        const schuelerDesLehrers = schueler.filter(s => s.lehrer === lehrerName).map(s => s.name);
        addNews(`Neue Bewertung f√ºr ${lehrerName}`, 
               `Gruppe "${thema}" zugewiesen mit Sch√ºler(n): ${schuelerDesLehrers.join(', ')}`, true);
    });
    
    // Felder zur√ºcksetzen
    document.getElementById('gruppenThema').value = '';
    document.querySelectorAll('.schueler-name').forEach(input => input.value = '');
    document.querySelectorAll('.schueler-lehrer').forEach(select => select.value = '');
    document.querySelectorAll('.schueler-fach').forEach(select => select.value = '');
    
    console.log('‚úÖ Gruppe erstellt:', thema, 'mit', schueler.length, 'Sch√ºlern');
    loadGruppen();
}

// Placeholder-Funktionen f√ºr andere Systeme
function loadLehrer() {
    console.log('üë®‚Äçüè´ Lade Lehrer-Verwaltung...');
    // Wird implementiert...
}

function loadDatenverwaltung() {
    console.log('üóÑÔ∏è Lade Datenverwaltung...');
    // Wird implementiert...
}

function loadBewertungen() {
    console.log('üìä Lade Bewertungen...');
    // Wird implementiert...
}

function loadVorlagen() {
    console.log('üìã Lade Vorlagen...');
    // Wird implementiert...
}

function loadUebersicht() {
    console.log('üìà Lade √úbersicht...');
    // Wird implementiert...
}

function loadAdminVorlagen() {
    console.log('‚öôÔ∏è Lade Admin-Vorlagen...');
    // Wird implementiert...
}

function loadThemen() {
    console.log('üí° Lade Themen...');
    // Wird von themen.js √ºbernommen
}

// addNews Hilfsfunktion
function addNews(titel, text, wichtig = false, autor = null, ablauf = null) {
    const neueNews = {
        titel,
        text,
        datum: new Date().toLocaleDateString('de-DE'),
        wichtig,
        autor: autor || (currentUser ? currentUser.name : 'System'),
        ablauf,
        gelesen: false
    };
    
    news.unshift(neueNews);
    console.log('üì∞ News hinzugef√ºgt:', titel);
}

// Sicherstellung dass alle Funktionen verf√ºgbar sind
console.log('‚úÖ Main.js vollst√§ndig geladen - alle Funktionen verf√ºgbar');